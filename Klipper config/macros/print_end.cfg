[gcode_macro PRINT_END]
default_parameter_X: 230
default_parameter_Y: 230
default_parameter_Z_LIFT: 70
gcode:
    M400                   	; wait for buffer to clear
    G91                 	; relative positioning
    G92 E0               	; zero the extruder
	
	{% set WAS_HOMED = ('z' in printer.toolhead.homed_axes) %}
    {% set CURRENT_Z = printer.gcode_move.gcode_position.z %}
    {% if WAS_HOMED and (Z_LIFT|float > 0)%}
        {% set Z_LEFT = (printer.toolhead.axis_maximum.z) - CURRENT_Z %}
        {% set MAX_LIFT = (Z_LIFT|float, Z_LEFT|float)|min %}
        {% if (MAX_LIFT|float) > 0 %}
            G1 Z{MAX_LIFT} F3000
        {% endif %}
    {% endif %}
	
	G90
	G1 X{X} Y{Y} F6000
	G91
	
	BED_MESH_CLEAR
	TURN_OFF_HEATERS
	M107 					; turn off fan
	M141 S35				; chamber cool down
	
	CLEAR_SCREEN