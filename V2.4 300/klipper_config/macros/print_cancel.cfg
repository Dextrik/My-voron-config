[gcode_macro CANCEL_PRINT]
rename_existing: BASE_CANCEL_PRINT
default_parameter_Z_LIFT: 20
gcode:
	TURN_OFF_HEATERS
	CLEAR_PAUSE
	BASE_CANCEL_PRINT
	SDCARD_RESET_FILE
	
  G91                    ; relative positioning
  G92 E0                 ; zero the extruder
  
  {% set WAS_HOMED = ('z' in printer.toolhead.homed_axes) %}
  {% set CURRENT_Z = printer.gcode_move.gcode_position.z %}
  {% if WAS_HOMED and (Z_LIFT|float > 0)%}
    {% set Z_LEFT = (printer.toolhead.axis_maximum.z) - CURRENT_Z %}
    {% set MAX_LIFT = (Z_LIFT|float, Z_LEFT|float)|min %}
    {% if (MAX_LIFT|float) > 0 %}
      G1 Z{MAX_LIFT} F3000
    {% endif %}
  {% endif %}
	
	M117 Print cancelled
	UPDATE_DELAYED_GCODE ID=SCHEDULE_CLEAR_SCREEN DURATION=10